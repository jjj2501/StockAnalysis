<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­–ç•¥å›æµ‹ - StockAnalysis AI</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">StockAnalysis AI</div>
            <p class="subtitle">ç­–ç•¥å›æµ‹çœ‹æ¿ï¼šéªŒè¯æ‚¨çš„æŠ•èµ„é€»è¾‘</p>
            <nav class="top-nav">
                <a href="index.html" class="nav-link">ğŸ  é¦–é¡µåˆ†æ</a>
                <a href="backtest.html" class="nav-link active">ğŸ“Š ç­–ç•¥å›æµ‹</a>
                <a href="data.html" class="nav-link">âš™ï¸ æ•°æ®ä¸­å¿ƒ</a>
            </nav>
        </header>

        <section class="backtest-controls card">
            <h3>å›æµ‹é…ç½®</h3>
            <div class="filter-row">
                <div class="input-group">
                    <label>è‚¡ç¥¨ä»£ç </label>
                    <input type="text" id="symbol" value="600519">
                </div>
                <div class="input-group">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="text" id="start-date" value="20230101" placeholder="YYYYMMDD">
                </div>
                <div class="input-group">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="text" id="end-date" value="20240101" placeholder="YYYYMMDD">
                </div>
                <div class="input-group">
                    <label>ç­–ç•¥ç±»å‹</label>
                    <select id="strategy">
                        <option value="macd">MACD é‡‘å‰/æ­»å‰</option>
                        <option value="rsi">RSI è¶…ä¹°è¶…å–</option>
                        <option value="ai">AI æ¨¡å‹é¢„æµ‹ (æ¼”ç¤º)</option>
                    </select>
                </div>
                <button id="run-backtest" class="primary-btn">è¿è¡Œå›æµ‹</button>
            </div>
        </section>

        <section id="backtest-results" class="hidden">
            <!-- ç»Ÿè®¡çœ‹æ¿ -->
            <div class="grid">
                <div class="card stat-card">
                    <span class="label">æ€»æ”¶ç›Šç‡</span>
                    <span class="value" id="total-return">0%</span>
                </div>
                <div class="card stat-card">
                    <span class="label">å¹´åŒ–æ”¶ç›Šç‡</span>
                    <span class="value" id="annual-return">0%</span>
                </div>
                <div class="card stat-card">
                    <span class="label">æœ€å¤§å›æ’¤</span>
                    <span class="value" id="max-drawdown">0%</span>
                </div>
                <div class="card stat-card">
                    <span class="label">å¤æ™®æ¯”ç‡</span>
                    <span class="value" id="sharpe">0.0</span>
                </div>
            </div>

            <!-- AI ç­–ç•¥è¯Šæ–­ -->
            <div class="card analysis-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">ğŸ¤– AI ç­–ç•¥è¯Šæ–­æŠ¥å‘Š</h3>
                    <button id="btn-generate-analysis" class="primary-btn hidden"
                        style="padding: 0.4rem 1rem; font-size: 0.9rem;">
                        âœ¨ ç”Ÿæˆæ·±åº¦åˆ†æ
                    </button>
                </div>
                <div id="ai-backtest-analysis" class="report-content hidden">
                    <!-- Report content will be injected here -->
                </div>
                <div id="ai-loading" class="hidden" style="color: #94a3b8; text-align: center; padding: 1rem;">
                    æ­£åœ¨è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆç­–ç•¥åˆ†æï¼Œè¯·ç¨å€™...
                </div>
            </div>

            <!-- èµ„äº§æ›²çº¿å›¾ -->
            <div class="card chart-card">
                <h3>å‡€å€¼æ›²çº¿ (Equity Curve)</h3>
                <div class="chart-container">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>

            <!-- äº¤æ˜“æµæ°´ -->
            <div class="card trades-card">
                <h3>äº¤æ˜“å†å²æµæ°´</h3>
                <div class="table-container">
                    <table id="trades-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>ç±»å‹</th>
                                <th>ä»·æ ¼</th>
                                <th>æ•°é‡</th>
                                <th>å‘ç”Ÿé‡‘é¢</th>
                            </tr>
                        </thead>
                        <tbody id="trades-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <script>
        let equityChart = null;
        let currentBacktestData = null;

        document.getElementById('btn-generate-analysis').addEventListener('click', async () => {
            if (!currentBacktestData) return;

            const btn = document.getElementById('btn-generate-analysis');
            const output = document.getElementById('ai-backtest-analysis');
            const loading = document.getElementById('ai-loading');

            btn.disabled = true;
            loading.classList.remove('hidden');
            output.classList.add('hidden');

            try {
                const response = await fetch('/api/backtest/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: currentBacktestData.symbol,
                        strategy: currentBacktestData.strategy,
                        summary: currentBacktestData.result.summary
                    })
                });

                if (!response.ok) throw new Error('åˆ†æè¯·æ±‚å¤±è´¥');

                const data = await response.json();
                let report = data.report || "æœªèƒ½ç”ŸæˆæŠ¥å‘Š";
                // ç®€å•çš„ Markdown å¤„ç† (å¦‚æœæ²¡å¼•ç”¨ marked.jsï¼Œè¿™é‡Œç›´æ¥æ˜¾ç¤ºæ–‡æœ¬å³å¯ï¼Œæˆ–è€…å‡è®¾ app.js é‡Œå·²æœ‰ marked)
                // æ³¨æ„ï¼šbacktest.html ç›®å‰æ²¡å¼•ç”¨ marked.jsï¼Œè¿™é‡Œæš‚æ—¶ç›´æ¥æ˜¾ç¤º raw text æˆ–ç®€å•æ›¿æ¢
                // è‹¥è¦æ”¯æŒ markdownï¼Œéœ€åœ¨ head å¼•å…¥ marked.js
                // report = report.replace(/<think>[\s\S]*?<\/think>/g, '').trim(); 

                output.innerText = report; // ä½¿ç”¨ innerText é˜²æ­¢ XSSï¼Œç®€å•èµ·è§
                output.classList.remove('hidden');
            } catch (e) {
                alert("ç”Ÿæˆåˆ†æå¤±è´¥: " + e.message);
            } finally {
                btn.disabled = false;
                loading.classList.add('hidden');
            }
        });

        document.getElementById('run-backtest').addEventListener('click', async () => {
            // ... (keep existing logic start)
            const symbol = document.getElementById('symbol').value;
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            const strategy = document.getElementById('strategy').value;

            const btn = document.getElementById('run-backtest');
            btn.disabled = true;
            btn.innerText = 'å›æµ‹ä¸­...';

            // é‡ç½®åˆ†æåŒºåŸŸ
            document.getElementById('ai-backtest-analysis').classList.add('hidden');
            document.getElementById('btn-generate-analysis').classList.add('hidden');

            try {
                const response = await fetch(`/api/backtest/${symbol}?start_date=${start}&end_date=${end}&strategy_type=${strategy}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'å›æµ‹æ¥å£å“åº”å¼‚å¸¸');
                }

                if (data.result && data.result.error) {
                    throw new Error(data.result.error);
                }

                currentBacktestData = data; // Store data
                displayResults(data);
                document.getElementById('backtest-results').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                alert('å›æµ‹å¤±è´¥: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'è¿è¡Œå›æµ‹';
            }
        });

        function displayResults(data) {
            const res = data.result;
            if (!res || !res.summary) {
                console.error('Invalid results:', res);
                return;
            }
            const summary = res.summary;
            document.getElementById('total-return').innerText = summary.total_return_pct.toFixed(2) + '%';
            document.getElementById('annual-return').innerText = summary.annual_return_pct.toFixed(2) + '%';
            document.getElementById('max-drawdown').innerText = summary.max_drawdown_pct.toFixed(2) + '%';
            document.getElementById('sharpe').innerText = summary.sharpe_ratio.toFixed(2);

            // æ˜¾ç¤ºç”ŸæˆæŒ‰é’®ï¼Œéšè—æ—§å†…å®¹
            document.getElementById('btn-generate-analysis').classList.remove('hidden');
            document.getElementById('ai-backtest-analysis').innerText = '';

            // èµ„äº§é¢œè‰²é€»è¾‘
            document.getElementById('total-return').style.color = summary.total_return_pct >= 0 ? 'var(--up-color, #ef4444)' : 'var(--down-color, #10b981)';

            // ç»˜åˆ¶å›¾è¡¨
            const ctx = document.getElementById('equityChart').getContext('2d');
            const labels = res.equity_curve.map(item => item.date);
            const values = res.equity_curve.map(item => item.equity);

            if (equityChart) equityChart.destroy();
            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'è´¦æˆ·æ€»èµ„äº§ (Equity)',
                        data: values,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // å¡«å……æµæ°´
            const tableBody = document.getElementById('trades-body');
            tableBody.innerHTML = res.trades.map(t => `
                <tr>
                    <td>${t.date}</td>
                    <td class="${t.type === 'BUY' ? 'up-text' : 'down-text'}">${t.type}</td>
                    <td>${t.price.toFixed(2)}</td>
                    <td>${t.shares}</td>
                    <td>${Number(t.cost ?? t.revenue ?? 0).toFixed(2)}</td>
                </tr>
            `).join('');
        }
    </script>

    <style>
        .filter-row {
            display: flex;
            gap: 1.5rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #64748b;
        }

        .input-group input,
        .input-group select {
            padding: 0.6rem 0.8rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .primary-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .primary-btn:hover {
            background: #2563eb;
        }

        .primary-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }

        .stat-card .label {
            display: block;
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .up-text {
            color: #ef4444;
            font-weight: 600;
        }

        .down-text {
            color: #10b981;
            font-weight: 600;
        }

        .report-content {
            white-space: pre-wrap;
            line-height: 1.6;
            color: #f1f5f9;
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 8px;
            font-family: inherit;
        }
    </style>
</body>

</html>